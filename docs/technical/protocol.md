# LocalSend 协议规范

本文档描述了 LocalSend 应用程序使用的通信协议，包括设备发现、连接、文件传输等核心功能的协议细节。

## 目录

- [概述](#概述)
- [版本历史](#版本历史)
- [设备发现](#设备发现)
- [文件传输](#文件传输)
- [安全机制](#安全机制)
- [错误处理](#错误处理)
- [协议兼容性](#协议兼容性)

## 概述

LocalSend 协议是一种基于 HTTP/HTTPS 的应用层协议，设计用于局域网中的设备发现和文件传输。该协议具有以下特点：

- **无需互联网**: 完全在局域网环境中工作
- **去中心化**: 点对点直接通信，无需中央服务器
- **安全**: 使用 HTTPS 加密通信
- **简单**: 基于标准的 HTTP REST API
- **轻量级**: 最小化协议开销
- **跨平台**: 适用于所有支持的操作系统

## 版本历史

LocalSend 协议经历了几次版本迭代：

### V1 (初始版本)
- 基本的设备发现和文件传输
- 不支持多文件传输

### V2 
- 增加了多文件传输支持
- 改进了设备发现机制
- 引入了拒绝传输的能力

### V2.1 (当前版本)
- 增加了文件夹结构保留
- 改进了错误处理和恢复机制
- 优化了大文件传输性能

## 设备发现

设备发现使用 UDP 多播消息实现，允许设备在局域网中找到彼此。

### 多播配置

- **多播地址**: 224.0.0.167
- **端口**: 53317
- **超时**: 500ms (默认)

### 发现消息格式

设备发送 UDP 多播消息，包含以下 JSON 格式的信息：

```json
{
  "alias": "设备名称",
  "version": "2.1",
  "deviceModel": "设备型号",
  "deviceType": "移动设备|桌面|服务器|Web",
  "fingerprint": "设备指纹",
  "port": 53317,
  "protocol": "https",
  "download": true|false,
  "announce": true
}
```

其中：
- `alias`: 用户设置的设备名称
- `version`: 协议版本
- `deviceModel`: 设备型号信息
- `deviceType`: 设备类型标识
- `fingerprint`: 设备唯一标识（用于验证）
- `port`: HTTP/HTTPS 服务端口
- `protocol`: 使用的协议（http 或 https）
- `download`: 是否接受下载请求
- `announce`: 表示这是一个公告消息

### 响应设备发现

当设备接收到发现请求时，会发送类似的 JSON 响应，但 `announce` 为 `false`，表示这是对发现请求的响应。

## 文件传输

文件传输使用 HTTP/HTTPS 协议进行，分为以下几个步骤：

### 1. 初始化传输会话

**请求**: `POST /api/send`

请求正文 (JSON):
```json
{
  "files": [
    {
      "id": "唯一文件ID",
      "fileName": "文件名.ext",
      "size": 文件大小,
      "fileType": "文件类型",
      "hash": "文件哈希值（可选）",
      "path": "目标相对路径（可选）"
    },
    ...
  ]
}
```

**响应**:
```json
{
  "sessionId": "会话ID",
  "status": "等待|接受|拒绝"
}
```

### 2. 检查会话状态

**请求**: `GET /api/send/{sessionId}`

**响应**:
```json
{
  "status": "等待|接受|拒绝",
  "destination": "接收方选择的保存目录（如果状态为'接受'）"
}
```

### 3. 传输文件

对于每个文件：

**请求**: `POST /api/send/{sessionId}/{fileId}`

请求头:
- `Content-Type`: `application/octet-stream`
- `Content-Length`: 文件大小
- `X-File-Size`: 文件大小（备用）

请求体: 文件的二进制内容

**响应**:
```json
{
  "status": "成功|失败",
  "message": "错误信息（如果失败）"
}
```

### 4. 完成传输

**请求**: `POST /api/send/{sessionId}/complete`

**响应**:
```json
{
  "status": "成功|失败"
}
```

## 安全机制

### TLS/SSL

所有 HTTPS 通信使用动态生成的自签名证书。为了防止中间人攻击，设备会通过指纹验证证书：

1. 首次连接时，用户会看到目标设备的指纹
2. 用户必须手动确认指纹匹配
3. 之后的通信使用 HTTPS 加密

### 用户确认

接收方必须显式接受每个传输会话，以防止未经授权的文件传输。

## 错误处理

协议定义了以下错误代码：

| 代码 | 含义 | 处理方式 |
|-----|------|---------|
| 400 | 错误请求 | 检查请求格式 |
| 403 | 拒绝访问 | 传输被目标设备拒绝 |
| 404 | 会话或文件不存在 | 检查 sessionId 和 fileId |
| 408 | 超时 | 可以重试传输 |
| 500 | 服务器错误 | 检查接收方存储空间等 |

### 文件传输恢复

对于大文件传输中断的情况，协议支持从断点恢复：

**请求**: `GET /api/send/{sessionId}/{fileId}/status`

**响应**:
```json
{
  "bytesReceived": 已接收字节数
}
```

随后的传输请求可以使用 `Range` 头来指定续传位置：

```
Range: bytes={bytesReceived}-
```

## 协议兼容性

为了确保不同版本的 LocalSend 客户端能够互操作，协议遵循以下兼容性规则：

1. **向后兼容性**: 较新版本的客户端可以与较旧版本通信，但功能可能受限
2. **版本协商**: 设备发现阶段会交换版本信息，以便客户端适应对方的功能
3. **核心功能保证**: 基本的文件传输在所有支持的版本之间都能工作

各版本特定特性：

| 功能 | V1 | V2 | V2.1 |
|-----|-----|-----|------|
| 单文件传输 | ✓ | ✓ | ✓ |
| 多文件传输 | ✗ | ✓ | ✓ |
| 文件夹结构 | ✗ | ✗ | ✓ |
| 断点续传 | ✗ | ✓ | ✓ |
| 设备类型识别 | ✓ | ✓ | ✓ |

## 开发者参考

### API 端点摘要

| 端点 | 方法 | 描述 |
|-----|-----|------|
| `/api/info` | GET | 获取设备信息 |
| `/api/send` | POST | 初始化传输会话 |
| `/api/send/{sessionId}` | GET | 检查会话状态 |
| `/api/send/{sessionId}/{fileId}` | POST | 传输单个文件 |
| `/api/send/{sessionId}/{fileId}/status` | GET | 获取文件传输状态 |
| `/api/send/{sessionId}/complete` | POST | 完成传输会话 |

### 实现提示

- **多线程传输**: 建议实现并行传输以提高效率
- **缓冲区大小**: 推荐的缓冲区大小为 1MB
- **异常处理**: 实现应妥善处理网络异常和中断
- **资源清理**: 确保在传输完成或失败后释放所有资源

如需查看协议的具体实现，请参考 `common/lib/src/protocol/` 目录中的代码。 